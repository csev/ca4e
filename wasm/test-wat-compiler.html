<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAT Compiler Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 40px; 
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #0056b3;
        }
        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .wat-code {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WAT Compiler Integration Test</h1>
        <p>This page tests the complete WAT → WASM → Execution pipeline using the new wat2wasm.php service.</p>
        
        <h3>Test WAT Code:</h3>
        <div class="wat-code" id="watSource">
(module
  ;; Import console.log from JavaScript
  (import "console" "log" (func $log (param i32 i32)))
  
  ;; Memory section - 1 page (64KB)
  (memory 1)
  
  ;; Data section - store "Hello from WAT Compiler!" string at offset 0
  (data (i32.const 0) "Hello from WAT Compiler!")
  
  ;; Export memory so JavaScript can access it
  (export "memory" (memory 0))
  
  ;; Main function that calls console.log
  (func $main
    ;; Call console.log with pointer 0 and length 23
    (call $log (i32.const 0) (i32.const 23))
  )
  
  ;; Export main function
  (export "main" (func $main))
)
        </div>
        
        <button onclick="testWATCompiler()">Test WAT Compiler</button>
        
        <div id="output" class="output">Click the button to test the WAT compiler...</div>
        
        <h3>What this tests:</h3>
        <ul>
            <li>WAT source code in proper format</li>
            <li>PHP wat2wasm.php service compilation</li>
            <li>WASM binary generation and streaming</li>
            <li>JavaScript WASM instantiation</li>
            <li>Memory access and string reading</li>
            <li>Console output from WASM</li>
        </ul>
    </div>

    <script>
        async function testWATCompiler() {
            const output = document.getElementById('output');
            output.textContent = 'Testing WAT compiler integration...\n';
            
            // WAT source code
            const watSource = `(module
  ;; Import console.log from JavaScript
  (import "console" "log" (func $log (param i32 i32)))
  
  ;; Memory section - 1 page (64KB)
  (memory 1)
  
  ;; Data section - store "Hello from WAT Compiler!" string at offset 0
  (data (i32.const 0) "Hello from WAT Compiler!")
  
  ;; Export memory so JavaScript can access it
  (export "memory" (memory 0))
  
  ;; Main function that calls console.log
  (func $main
    ;; Call console.log with pointer 0 and length 23
    (call $log (i32.const 0) (i32.const 23))
  )
  
  ;; Export main function
  (export "main" (func $main))
)`;
            
            try {
                // Step 1: Compile WAT to WASM using wat2wasm.php
                output.textContent += 'Step 1: Compiling WAT to WASM...\n';
                const response = await fetch('wat2wasm.php', {
                    method: 'POST',
                    body: watSource,
                    headers: {
                        'Content-Type': 'text/plain'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`WAT compilation failed: ${errorText}`);
                }
                
                const wasmBytes = await response.arrayBuffer();
                output.textContent += `✅ WAT compiled successfully! WASM size: ${wasmBytes.byteLength} bytes\n`;
                
                // Step 2: Instantiate WASM module
                output.textContent += 'Step 2: Instantiating WASM module...\n';
                
                // Import object that provides console.log to WASM
                const importObject = {
                    console: {
                        log: (ptr, len) => {
                            // Read the string from memory starting at pointer
                            const memory = module.instance.exports.memory;
                            const bytes = new Uint8Array(memory.buffer, ptr, len);
                            let str = '';
                            for (let i = 0; i < len; i++) {
                                str += String.fromCharCode(bytes[i]);
                            }
                            output.textContent += `✅ WASM called console.log with: "${str}"\n`;
                            console.log('WASM says:', str);
                        }
                    }
                };
                
                const module = await WebAssembly.instantiate(wasmBytes, importObject);
                output.textContent += '✅ WASM module instantiated successfully!\n';
                
                // Step 3: Execute the WASM module
                output.textContent += 'Step 3: Executing WASM module...\n';
                
                if (module.instance.exports.main) {
                    const result = module.instance.exports.main();
                    output.textContent += `✅ Main function executed. Result: ${result}\n`;
                } else {
                    output.textContent += '❌ No main function found in exports\n';
                }
                
                output.textContent += '🎉 WAT Compiler Integration Test Completed Successfully!\n';
                output.textContent += '\nThe complete pipeline is working:\n';
                output.textContent += 'WAT → wat2wasm.php → WASM binary → JavaScript execution → "Hello from WAT Compiler!"\n';
                
            } catch (error) {
                output.textContent += `❌ Error: ${error.message}\n`;
                console.error('WAT Compiler Test Error:', error);
            }
        }
    </script>
</body>
</html> 